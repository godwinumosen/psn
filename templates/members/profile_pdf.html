from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.units import inch
from reportlab.lib import colors
from reportlab.lib.utils import ImageReader
from reportlab.platypus import Table, TableStyle

@login_required
def profile_pdf(request):
    clearance = ClearanceApplication.objects.filter(
        user=request.user
    ).order_by('-submitted_at').first()

    if not clearance or not clearance.approved:
        return HttpResponseForbidden(
            "You cannot download this PDF until your clearance is approved."
        )

    response = HttpResponse(content_type='application/pdf')
    response['Content-Disposition'] = f'attachment; filename="profile_{request.user.username}.pdf"'

    p = canvas.Canvas(response, pagesize=A4)
    width, height = A4

    # ===== PAGE MARGINS =====
    left_margin = 50
    top_margin = height - 50
    current_y = top_margin

    # ===== HEADER =====
    p.setFont("Helvetica-Bold", 28)
    p.setFillColor(colors.HexColor("#2d6a4f"))
    p.drawString(left_margin, current_y, f"{request.user.get_full_name()}'s Profile")
    current_y -= 40

    # ===== PROFILE IMAGE =====
    if request.user.passport_photo:
        try:
            img = ImageReader(request.user.passport_photo.path)
            p.drawImage(
                img,
                width - 170,
                top_margin - 120,
                120,
                130,
                mask='auto'
            )
        except Exception:
            pass

    # ===== PROFILE CARD =====
    profile_data = [
        ("Full Name", request.user.get_full_name()),
        ("PCN Registration Number", getattr(request.user, "pcn_number", "")),
        ("Email", request.user.email),
        ("Area of Practice", getattr(request.user, "area_of_practice", "")),
        ("Technical Group", clearance.get_technical_group_display() if clearance else ""),
        ("Clearance Year", clearance.clearance_year if clearance else ""),
    ]

    y = current_y - 20
    p.setFont("Helvetica-Bold", 12)
    p.setFillColor(colors.HexColor("#555"))
    for label, value in profile_data:
        p.drawString(left_margin, y, f"{label}:")
        p.setFont("Helvetica", 12)
        p.setFillColor(colors.HexColor("#2d6a4f"))
        p.drawString(left_margin + 180, y, str(value))
        y -= 22
        p.setFont("Helvetica-Bold", 12)
        p.setFillColor(colors.HexColor("#555"))

    # ===== CLEARANCE CARD =====
    y -= 10
    p.setFont("Helvetica-Bold", 18)
    p.setFillColor(colors.HexColor("#2d6a4f"))
    p.drawString(left_margin, y, "Clearance Status")
    y -= 22

    clearance_status = clearance.status if clearance else "Pending"
    clearance_comments = getattr(clearance, "comments", "Your application is being reviewed.")

    # Draw table for status
    table_data = [
        ["Status", clearance_status],
        ["Comments", clearance_comments],
    ]
    table = Table(table_data, colWidths=[150, 350])
    table.setStyle(TableStyle([
        ('BACKGROUND', (0,0), (-1,0), colors.HexColor("#2d6a4f")),
        ('TEXTCOLOR', (0,0), (-1,0), colors.white),
        ('GRID', (0,0), (-1,-1), 1, colors.grey),
        ('FONTNAME', (0,0), (-1,0), 'Helvetica-Bold'),
        ('FONTNAME', (0,1), (-1,-1), 'Helvetica'),
        ('VALIGN', (0,0), (-1,-1), 'MIDDLE'),
        ('LEFTPADDING', (0,0), (-1,-1), 8),
        ('RIGHTPADDING', (0,0), (-1,-1), 8),
        ('TOPPADDING', (0,0), (-1,-1), 6),
        ('BOTTOMPADDING', (0,0), (-1,-1), 6),
    ]))
    table.wrapOn(p, width, height)
    table.drawOn(p, left_margin, y - 50)

    # ===== FOOTER =====
    p.setFont("Helvetica-Oblique", 9)
    p.setFillColor(colors.grey)
    p.drawCentredString(width / 2, 40,
                        "This document was generated electronically and is valid without signature.")

    p.showPage()
    p.save()

    return response
